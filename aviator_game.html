<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aviator</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <style>
        :root { --bg-main: #0f1923; --bg-panel: #212d3a; --bg-darker: #1a2430; --text-primary: #ffffff; --text-secondary: #8a99a8; --green: #00c74a; --red: #ff5555; --yellow: #f1c40f; --blue: #5bc0de; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        .loading-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-main); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-primary); }
        .loading-wrapper p { font-size: 1.5em; }
        .loading-wrapper .error-message { color: var(--red); font-size: 1em; text-align: center; padding: 0 20px; }

        .mobile-frame { width: 100%; height: 100%; max-width: 420px; max-height: 900px; background-color: var(--bg-main); display: none; flex-direction: column; border-radius: 20px; overflow: hidden; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--bg-darker); flex-shrink: 0; }
        .logo { font-weight: 700; color: var(--red); font-size: 1.2em; }
        .balance-container { display: flex; align-items: center; gap: 5px; font-weight: 600; cursor: pointer; }
        .coin { font-size: 1.2em; }
        .menu-icons { display: flex; gap: 15px; font-size: 1.1em; }
        #user-id-icon { cursor: help; }
        .history-bar { display: flex; gap: 10px; padding: 8px 15px; background-color: var(--bg-darker); overflow-x: auto; white-space: nowrap; flex-shrink: 0; }
        .history-bar::-webkit-scrollbar { height: 0; }
        .history-item { font-weight: 500; padding: 2px 5px; border-radius: 4px; }
        .history-item.low { color: var(--blue); }
        .history-item.mid { color: var(--yellow); }
        .history-item.high { color: var(--red); }
        .game-area { flex-grow: 1; position: relative; background: radial-gradient(ellipse at 50% 150%, rgba(20, 107, 204, 0.25) 0%, rgba(15, 25, 35, 0) 60%), var(--bg-main); overflow: hidden; }
        #graph-canvas { width: 100%; height: 100%; position: absolute; }
        .multiplier { width: 100%; height: 100%; display: none; justify-content: center; align-items: center; font-size: 5em; font-weight: 700; color: var(--text-primary); }
        .status-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; font-weight: 600; color: var(--yellow); text-align: center; }
        .game-area.running .multiplier { display: flex; }
        .game-area.crashed .multiplier { color: var(--red); animation: shake 0.5s; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } }
        .controls-area { padding: 10px; display: flex; flex-direction: column; gap: 10px; background-color: var(--bg-darker); flex-shrink: 0; }
        .bet-panel { background: var(--bg-panel); border-radius: 8px; padding: 8px; }
        .panel-body { display: flex; gap: 10px; margin-bottom: 8px; }
        .bet-input-group { flex: 2; display: flex; }
        .bet-amount { width: 100%; text-align: center; font-size: 1.1em; font-weight: 600; background: var(--bg-darker); color: var(--text-primary); border: 1px solid var(--bg-main); border-left: none; border-right: none; }
        .amount-btn { background: var(--bg-darker); border: 1px solid var(--bg-main); color: var(--text-primary); font-size: 1.2em; padding: 5px 12px; }
        .amount-btn.minus { border-radius: 5px 0 0 5px; }
        .amount-btn.plus { border-radius: 0 5px 5px 0; }
        .bet-btn { width: 100%; padding: 10px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background-color: var(--green); color: var(--text-primary); display: flex; flex-direction: column; align-items: center; }
        .bet-btn .bet-value { font-size: 0.8em; opacity: 0.8; }
        .bet-btn.cashout { background-color: var(--yellow); }
        .bet-btn.disabled { background-color: #555; cursor: not-allowed; }
        .bet-btn.pending { background-color: var(--blue); }
        .bottom-tabs { display: flex; background: var(--bg-darker); margin-top: auto; flex-shrink: 0; }
        .bottom-tab { flex: 1; padding: 15px; font-size: 1em; background: transparent; border: none; color: var(--text-secondary); }
        .bottom-tab.active { border-top: 2px solid var(--green); color: var(--text-primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 101; display: none; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-panel); padding: 20px; border-radius: 10px; z-index: 102; width: 85%; max-width: 350px; display: none; flex-direction: column; gap: 15px; }
        .modal h3 { text-align: center; margin: 0 0 10px 0; color: var(--text-primary); }
        .modal .instruction { text-align: center; color: var(--yellow); font-size: 0.9em; word-wrap: break-word; }
        .modal-input, .modal select { width: 100%; padding: 12px; background: var(--bg-darker); border: 1px solid var(--bg-main); border-radius: 5px; color: var(--text-primary); font-size: 1em; }
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .modal-btn.deposit-btn, .modal-btn.confirm-deposit { background-color: var(--green); color: var(--text-primary); }
        .modal-btn.withdraw-btn, .modal-btn.confirm-withdraw { background-color: var(--blue); color: var(--text-primary); }
    </style>
</head>
<body>
    <div class="loading-wrapper" id="loading-wrapper">
        <p>Connecting...</p>
        <p class="error-message" id="loading-error"></p>
    </div>

    <div class="mobile-frame" id="game-wrapper">
        <div class="top-bar">
            <span class="logo">Aviator</span>
            <div class="balance-container">
                <span class="coin">üí∞</span>
                <span id="balance">0.00 USD</span>
            </div>
            <div class="menu-icons">
                 <i class="fa-solid fa-user" id="user-id-icon" title="Your User ID"></i>
            </div>
        </div>
        <div class="history-bar" id="history-bar"></div>
        <div class="game-area">
            <canvas id="graph-canvas"></canvas>
            <div class="multiplier" id="multiplier">1.00x</div>
            <div class="status-text" id="status-text">Connecting...</div>
        </div>
        <div class="controls-area">
             <div class="bet-panel" data-panel-id="0">
                <div class="panel-body">
                    <div class="bet-input-group">
                        <button class="amount-btn minus">-</button>
                        <input type="number" class="bet-amount" value="1.00">
                        <button class="amount-btn plus">+</button>
                    </div>
                </div>
                <button class="bet-btn">
                    <span class="bet-text">BET</span>
                    <span class="bet-value">1.00 USD</span>
                </button>
            </div>
             <div class="bet-panel" data-panel-id="1">
                <div class="panel-body">
                     <div class="bet-input-group">
                        <button class="amount-btn minus">-</button>
                        <input type="number" class="bet-amount" value="1.00">
                        <button class="amount-btn plus">+</button>
                    </div>
                </div>
                <button class="bet-btn">
                    <span class="bet-text">BET</span>
                    <span class="bet-value">1.00 USD</span>
                </button>
            </div>
        </div>
        <div class="bottom-tabs">
            <button class="bottom-tab active">All Bets</button>
            <button class="bottom-tab">My Bets</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal" id="balance-modal">
        <button class="modal-btn deposit-btn">Deposit</button>
        <button class="modal-btn withdraw-btn">Withdraw</button>
    </div>
    
    <div class="modal" id="deposit-modal">
        <h3>Deposit</h3>
        <select class="modal-input" id="deposit-method">
            <option value="bKash">bKash</option>
            <option value="nagad">Nagad</option>
            <option value="binance">Binance</option>
        </select>
        
        <div id="bkash-nagad-deposit-fields">
            <p class="instruction"><strong>01816395401</strong> ‡¶è‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <input type="text" class="modal-input" id="deposit-trxId" placeholder="Transaction ID">
        </div>

        <div id="binance-deposit-fields" style="display: none;">
            <p class="instruction">TRC20 Address:<br><strong>TBiXWE9hnHSvJNGEc6TkviAeA7NP4ft9BF</strong></p>
            <input type="text" class="modal-input" id="deposit-binanceId" placeholder="Your Binance ID / Pay ID">
        </div>
        
        <input type="number" class="modal-input" id="deposit-amount" placeholder="Deposit Amount">
        <button class="modal-btn confirm-deposit">Confirm Deposit</button>
    </div>

    <div class="modal" id="withdraw-modal">
        <h3>Withdraw</h3>
        <select class="modal-input" id="withdraw-method">
            <option value="bKash">bKash</option>
            <option value="nagad">Nagad</option>
            <option value="binance">Binance</option>
        </select>

        <div id="bkash-nagad-withdraw-fields">
            <input type="text" class="modal-input" id="withdraw-number" placeholder="Your bKash/Nagad Number">
        </div>
        
        <div id="binance-withdraw-fields" style="display: none;">
            <input type="text" class="modal-input" id="withdraw-address-trc20" placeholder="Your TRC20 Address">
        </div>

        <input type="number" class="modal-input" id="withdraw-amount" placeholder="Withdraw Amount">
        <button class="modal-btn confirm-withdraw">Confirm Withdraw</button>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDg1GQ-TApuxhLSKnQu3YMmjXP6_xXlTig",
          authDomain: "aviator-96468.firebaseapp.com",
          databaseURL: "https://aviator-96468-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "aviator-96468",
          storageBucket: "aviator-96468.appspot.com",
          messagingSenderId: "265192541811",
          appId: "1:265192541811:web:6bdb146496593473fce406"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const loadingWrapper = document.getElementById('loading-wrapper');
        const gameWrapper = document.getElementById('game-wrapper');
        const loadingError = document.getElementById('loading-error');
        
        let currentUser;

        async function main() {
            try {
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                let user = auth.currentUser;
                if (!user) {
                    const userCredential = await auth.signInAnonymously();
                    user = userCredential.user;
                }
                currentUser = user;
                
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    await userRef.set({
                        isAnonymous: true,
                        balance: 1000.00,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                loadingWrapper.style.display = 'none';
                gameWrapper.style.display = 'flex';
                initializeAppLogic();
            } catch (error) {
                console.error("Critical Error during startup:", error);
                loadingError.textContent = "Could not connect to the game server. Please refresh.";
            }
        }

        main();

        function initializeAppLogic() {
            if (!currentUser) return;

            const canvas = document.getElementById('graph-canvas');
            const ctx = canvas.getContext('2d');
            const multiplierEl = document.getElementById('multiplier');
            const statusTextEl = document.getElementById('status-text');
            const balanceEl = document.getElementById('balance');
            document.getElementById('user-id-icon').title = `User ID: ${currentUser.uid}`;
            
            function resizeCanvas() {
                if(!canvas.parentElement) return;
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            function drawGraph(multiplier) {
                if (!ctx) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const elapsed = (multiplier - 1) * 10;
                const endX = elapsed * (canvas.width / 100);
                const endY = canvas.height - Math.pow(elapsed, 1.6);
                ctx.beginPath();
                ctx.moveTo(0, canvas.height);
                ctx.lineTo(endX, endY);
                ctx.lineTo(endX, canvas.height);
                ctx.closePath();
                const gradient = ctx.createLinearGradient(0, endY, 0, canvas.height);
                gradient.addColorStop(0, 'rgba(255, 85, 85, 0.5)');
                gradient.addColorStop(1, 'rgba(255, 85, 85, 0)');
                ctx.fillStyle = gradient;
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(0, canvas.height);
                ctx.lineTo(endX, endY);
                ctx.strokeStyle = 'var(--red)';
                ctx.lineWidth = 4;
                ctx.stroke();
            }

            db.collection("gameState").doc("current").onSnapshot((doc) => {
                const state = doc.data();
                if (!state) return;
                multiplierEl.textContent = `${state.multiplier.toFixed(2)}x`;
                const gameArea = canvas.parentElement;
                gameArea.classList.remove('running', 'crashed');
                if (state.status === 'running') {
                    gameArea.classList.add('running');
                    statusTextEl.style.display = 'none';
                    drawGraph(state.multiplier);
                } else if (state.status === 'crashed') {
                    gameArea.classList.add('crashed');
                    statusTextEl.style.display = 'block';
                    statusTextEl.textContent = `Crashed @ ${state.multiplier.toFixed(2)}x`;
                } else if (state.status === 'betting') {
                    statusTextEl.style.display = 'block';
                    statusTextEl.textContent = `Round starts in ${state.countdown}s...`;
                    drawGraph(1.0);
                }
            });

            db.collection("users").doc(currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    balanceEl.textContent = `${doc.data().balance.toFixed(2)} USD`;
                }
            });
            
            const modalOverlay = document.getElementById('modal-overlay');
            document.querySelector('.balance-container').addEventListener('click', () => {
                modalOverlay.style.display = 'block';
                document.getElementById('balance-modal').style.display = 'flex';
            });
            modalOverlay.addEventListener('click', () => {
                modalOverlay.style.display = 'none';
                document.getElementById('balance-modal').style.display = 'none';
                document.getElementById('deposit-modal').style.display = 'none';
                document.getElementById('withdraw-modal').style.display = 'none';
            });
            document.querySelector('.deposit-btn').addEventListener('click', () => { document.getElementById('balance-modal').style.display = 'none'; document.getElementById('deposit-modal').style.display = 'flex'; });
            document.querySelector('.withdraw-btn').addEventListener('click', () => { document.getElementById('balance-modal').style.display = 'none'; document.getElementById('withdraw-modal').style.display = 'flex'; });
            
            const depositMethodSelect = document.getElementById('deposit-method');
            const bkashNagadDepositFields = document.getElementById('bkash-nagad-deposit-fields');
            const binanceDepositFields = document.getElementById('binance-deposit-fields');

            depositMethodSelect.addEventListener('change', (e) => {
                if (e.target.value === 'binance') {
                    bkashNagadDepositFields.style.display = 'none';
                    binanceDepositFields.style.display = 'block';
                } else {
                    bkashNagadDepositFields.style.display = 'block';
                    binanceDepositFields.style.display = 'none';
                }
            });

            document.querySelector('.confirm-deposit').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('deposit-amount').value);
                const method = depositMethodSelect.value;
                let requestData = {
                    userId: currentUser.uid,
                    type: "deposit",
                    amount: amount,
                    method: method,
                    status: "pending",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (method === 'binance') {
                    const binanceId = document.getElementById('deposit-binanceId').value;
                    if (!amount || !binanceId) { alert('Please fill all fields.'); return; }
                    requestData.binanceId = binanceId;
                } else {
                    const trxId = document.getElementById('deposit-trxId').value;
                    if (!amount || !trxId) { alert('Please fill all fields.'); return; }
                    requestData.trxId = trxId;
                }

                db.collection("requests").add(requestData).then(() => {
                    alert('Deposit request sent!');
                    modalOverlay.click();
                });
            });

            const withdrawMethodSelect = document.getElementById('withdraw-method');
            const bkashNagadWithdrawFields = document.getElementById('bkash-nagad-withdraw-fields');
            const binanceWithdrawFields = document.getElementById('binance-withdraw-fields');

            withdrawMethodSelect.addEventListener('change', (e) => {
                 if (e.target.value === 'binance') {
                    bkashNagadWithdrawFields.style.display = 'none';
                    binanceWithdrawFields.style.display = 'block';
                } else {
                    bkashNagadWithdrawFields.style.display = 'block';
                    binanceWithdrawFields.style.display = 'none';
                }
            });

            document.querySelector('.confirm-withdraw').addEventListener('click', () => {
                 const amount = parseFloat(document.getElementById('withdraw-amount').value);
                 const method = withdrawMethodSelect.value;
                 let requestData = {
                    userId: currentUser.uid,
                    type: "withdraw",
                    amount: amount,
                    method: method,
                    status: "pending",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                 };

                 if (method === 'binance') {
                     const withdrawAddress = document.getElementById('withdraw-address-trc20').value;
                     if (!amount || !withdrawAddress) { alert('Please fill all fields.'); return; }
                     requestData.withdrawAddress = withdrawAddress;
                 } else {
                     const number = document.getElementById('withdraw-number').value;
                     if (!amount || !number) { alert('Please fill all fields.'); return; }
                     requestData.number = number;
                 }

                 db.collection("requests").add(requestData).then(() => {
                    alert('Withdraw request sent!');
                    modalOverlay.click();
                });
            });
        }
    </script>
</body>
</html>
